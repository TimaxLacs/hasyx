# PWA Support

PWA (Progressive Web App) Support in Hasyx

Hasyx includes comprehensive Progressive Web App (PWA) support, allowing your applications to provide a native app-like experience on web, mobile, and desktop platforms.

## Features

- ‚úÖ **Service Worker** for offline functionality and caching
- ‚úÖ **Web App Manifest** for installability
- ‚úÖ **Push Notifications** (integrates with existing Firebase setup)
- ‚úÖ **Offline Support** with intelligent caching strategies
- ‚úÖ **Install Prompts** for all platforms (Android, iOS, Desktop)
- ‚úÖ **App Updates** with automatic detection and user prompts
- ‚úÖ **Native App Feel** with splash screens and app icons
- ‚úÖ **Automatic Asset Generation** from your logo.svg

## Quick Start

### 1. Generate PWA Assets

First, generate all necessary icons and assets from your logo:

```bash
npx hasyx assets
```

This command automatically generates:
- üì± **PWA icons** in all required sizes (48px to 512px) in WebP format
- üñºÔ∏è **PNG fallbacks** for better compatibility (192px, 512px)
- üñ•Ô∏è **Favicon** for browsers
- üì± **Capacitor assets** for mobile apps
- üñ•Ô∏è **Electron assets** if Electron is detected

**Requirements:**
- Your `public/logo.svg` file (created automatically by `npx hasyx init`)
- The command creates icons in `public/icons/` directory
- Icons are referenced in the PWA manifest

### 2. Enable PWA in Your App

PWA features are automatically enabled when you use the Hasyx framework. The necessary files are already included:

- `public/manifest.webmanifest` - Web app manifest
- `public/sw.js` - Main service worker
- `public/firebase-messaging-sw.js` - Firebase messaging service worker
- `public/icons/` - App icons in various sizes (generated by `npx hasyx assets`)
- `public/browserconfig.xml` - Windows PWA support

### 3. Use PWA Components

PWA components are automatically included in your layout for all pages:

```tsx
// app/layout.tsx (already configured in Hasyx)
import { HasyxProvider } from "hasyx";
import { PWAInstallPrompt, PWAStatus } from "hasyx/components/pwa-install-prompt";

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html>
      <body>
        <HasyxProvider>
          {children}
          
          {/* PWA Components - available on all pages */}
          <PWAInstallPrompt />
          <PWAStatus />
        </HasyxProvider>
      </body>
    </html>
  );
}
```

### 4. Use PWA Hooks

Access PWA functionality in your components:

```tsx
import { usePWA } from 'hasyx';

function MyComponent() {
  const { 
    isInstalled, 
    installPromptAvailable, 
    updateAvailable,
    install, 
    update,
    showNotification 
  } = usePWA();

  return (
    <div>
      {!isInstalled && installPromptAvailable && (
        <button onClick={install}>
          Install App
        </button>
      )}
      
      {updateAvailable && (
        <button onClick={update}>
          Update Available - Click to Update
        </button>
      )}
      
      <button onClick={() => showNotification('Hello!', { body: 'PWA is working!' })}>
        Test Notification
      </button>
    </div>
  );
}
```

## Configuration

### Environment Variables

PWA works with your existing Hasyx environment variables. No additional configuration needed for basic functionality.

For Firebase push notifications, ensure you have:

```env
# Firebase configuration (already used by Hasyx notify system)
NEXT_PUBLIC_FIREBASE_API_KEY=your_api_key
NEXT_PUBLIC_FIREBASE_PROJECT_ID=your_project_id
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=your_sender_id
NEXT_PUBLIC_FIREBASE_APP_ID=your_app_id
NEXT_PUBLIC_FIREBASE_VAPID_KEY=your_vapid_key
```

### Customizing the Web App Manifest

Edit `public/manifest.webmanifest` to customize your app's identity:

```json
{
  "name": "Your App Name",
  "short_name": "YourApp",
  "description": "Description of your app",
  "theme_color": "#your-brand-color",
  "background_color": "#your-bg-color",
  // ... other settings
}
```

### Customizing App Icons

Replace the icons in the `icons/` directory with your own:

- `icon-48.webp` through `icon-512.webp`
- Use the `npx hasyx assets` command to generate icons from your logo

## Service Worker Caching Strategies

The PWA service worker uses different caching strategies for different types of resources:

### Network First (API Calls)
- `/api/graphql` - Hasura GraphQL API
- `/api/auth/*` - Authentication endpoints
- Tries network first, falls back to cache
- Provides offline fallback responses

### Cache First (Static Assets)
- JavaScript, CSS, images, fonts
- Icons and static resources
- Serves from cache immediately if available

### Stale While Revalidate (Pages)
- HTML pages and dynamic content
- Serves cached version immediately
- Updates cache in background

## Offline Support

### GraphQL Offline Handling

When offline, GraphQL requests return a proper error response:

```json
{
  "data": null,
  "errors": [{ "message": "Offline - Please check your connection" }]
}
```

Your components can handle this gracefully:

```tsx
const { data, loading, error } = useQuery({
  table: 'users',
  returning: ['id', 'name']
});

if (error?.message?.includes('Offline')) {
  return <div>You're offline. Some features may be limited.</div>;
}
```

### Custom Offline Pages

The service worker provides a default offline page, but you can customize it by modifying the `createOfflineFallback` function in `public/sw.js`.

## Platform-Specific Features

### iOS Safari

- Automatic detection of iOS devices
- Shows appropriate installation instructions
- Handles iOS-specific PWA behaviors

### Android Chrome

- Native install prompt
- Add to Home Screen functionality
- Full PWA feature support

### Desktop Browsers

- Install as desktop app
- Window controls and app-like experience
- Keyboard shortcuts and native feel

## Testing PWA Features

### 1. Chrome DevTools

1. Open DevTools ‚Üí Application tab
2. Check "Service Workers" section
3. Use "Manifest" section to validate manifest
4. Test offline mode with Network tab

### 2. PWA Checklist

Use Chrome DevTools Lighthouse to audit PWA compliance:

```bash
# Run PWA audit
npx lighthouse http://localhost:3000 --view
```

### 3. Testing Installation

1. **Desktop**: Look for install icon in address bar
2. **Mobile**: Use "Add to Home Screen" in browser menu
3. **Testing**: Use incognito mode for fresh testing

### 4. Testing Offline

1. Open DevTools ‚Üí Network tab
2. Enable "Offline" checkbox
3. Refresh page to test offline functionality
4. Try navigating to different pages

## Deployment Considerations

### HTTPS Requirement

PWA features require HTTPS in production. Hasyx deployments on Vercel automatically provide HTTPS.

### Service Worker Scope

The service worker is registered with scope `/` to cache the entire application. Ensure your deployment serves the service worker from the root.

### CDN and Caching

When using CDNs, ensure service worker files are not cached:

```
# In your CDN config
/sw.js - Cache-Control: no-cache
/firebase-messaging-sw.js - Cache-Control: no-cache
```

## Integration with Existing Features

### Firebase Notifications

PWA seamlessly integrates with Hasyx's existing Firebase notification system:

- Background notifications work automatically
- Notification clicks open the app
- Existing notification permissions are reused

### GraphQL Subscriptions

PWA works with WebSocket subscriptions:

- Subscriptions continue working when online
- Graceful fallback when offline
- Automatic reconnection when back online

### Authentication

PWA respects authentication state:

- Cached API responses include auth context
- Login state persists across app installs
- Session handling works in standalone mode

## Troubleshooting

### Service Worker Not Registering

1. Check browser console for errors
2. Ensure HTTPS in production
3. Verify service worker file is accessible
4. Check service worker scope

### Install Prompt Not Showing

1. Ensure PWA criteria are met (manifest, service worker, HTTPS)
2. Check that user hasn't already dismissed prompt
3. Test in incognito mode
4. Verify manifest is valid

### Offline Functionality Not Working

1. Check service worker registration
2. Verify network requests are being cached
3. Test cache API in DevTools
4. Check service worker fetch event handlers

### Notifications Not Working

1. Verify notification permissions
2. Check Firebase configuration
3. Ensure service worker is active
4. Test with browser notification API first

## Best Practices

### 1. Progressive Enhancement

Design your app to work without PWA features:

```tsx
const { isSupported } = usePWA();

return (
  <div>
    {isSupported ? (
      <PWAFeatures />
    ) : (
      <RegularWebFeatures />
    )}
  </div>
);
```

### 2. User Communication

Always inform users about PWA features:

- Show benefits of installation
- Explain offline capabilities
- Provide clear update notifications

### 3. Graceful Degradation

Handle PWA failures gracefully:

```tsx
try {
  await install();
} catch (error) {
  // Fallback to regular web app experience
  console.log('Installation failed, continuing as web app');
}
```

### 4. Performance Optimization

- Minimize service worker size
- Cache only essential resources initially
- Use efficient caching strategies
- Monitor cache storage usage

## Advanced Usage

### Custom Service Worker

If you need custom service worker functionality, modify `public/sw.js`:

```javascript
// Add custom caching rules
const CUSTOM_CACHE_PATTERNS = [
  /^\/custom-api\/.*/,
];

// Add custom event listeners
self.addEventListener('sync', (event) => {
  if (event.tag === 'custom-sync') {
    event.waitUntil(doCustomSync());
  }
});
```

### Background Sync

Implement background sync for offline actions:

```typescript
// Register background sync
if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
  navigator.serviceWorker.ready.then((registration) => {
    return registration.sync.register('background-sync');
  });
}
```

### Push Notification Customization

Extend notification handling:

```typescript
import { showNotification } from 'hasyx/lib/pwa';

// Custom notification with actions
showNotification('New Message', {
  body: 'You have a new message',
  actions: [
    { action: 'reply', title: 'Reply' },
    { action: 'mark-read', title: 'Mark as Read' }
  ],
  data: { messageId: '123' }
});
```

## API Reference

### `usePWA()` Hook

Returns an object with PWA state and actions:

```typescript
interface PWAState {
  isSupported: boolean;        // PWA features supported
  isInstalled: boolean;        // App is installed
  installPromptAvailable: boolean; // Install prompt available
  updateAvailable: boolean;    // App update available
  displayMode: string;         // Current display mode
  isInitialized: boolean;      // PWA system initialized
}

interface PWAActions {
  install: () => Promise<void>;              // Trigger install prompt
  update: () => Promise<void>;               // Update service worker
  showNotification: (title, options) => void; // Show notification
  dismissUpdate: () => void;                 // Dismiss update prompt
}
```

### PWA Utility Functions

```typescript
import {
  registerServiceWorker,
  updateServiceWorker,
  isPWA,
  getPWADisplayMode,
  requestNotificationPermission,
  showNotification,
  checkPWASupport,
  initializePWA
} from 'hasyx/lib/pwa';
```

## Learn More

- [Web.dev PWA Guide](https://web.dev/progressive-web-apps/)
- [MDN Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
- [PWA Builder](https://www.pwabuilder.com/)
- [Workbox (Advanced PWA Library)](https://developers.google.com/web/tools/workbox) 